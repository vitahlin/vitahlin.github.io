<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Mysql数据库设计规范 - VitahLin</title><meta name=Description content="深自缄默，如云漂泊。"><meta property="og:title" content="Mysql数据库设计规范"><meta property="og:description" content="表结构设计 不在数据库做运算，同时运算的字段也无法使用索引 控制单表数量，纯 INT 不超过1000W行，含 CHAR 不超过500W 合理分表，比如按用户 UserId ，日期"><meta property="og:type" content="article"><meta property="og:url" content="http://www.vitahlin.com/mysql-design-guideline/"><meta property="og:image" content="http://www.vitahlin.com/static/28-011359_630.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-15T12:00:00+08:00"><meta property="article:modified_time" content="2022-03-15T12:05:18+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://www.vitahlin.com/static/28-011359_630.png"><meta name=twitter:title content="Mysql数据库设计规范"><meta name=twitter:description content="表结构设计 不在数据库做运算，同时运算的字段也无法使用索引 控制单表数量，纯 INT 不超过1000W行，含 CHAR 不超过500W 合理分表，比如按用户 UserId ，日期"><meta name=application-name content="VitahLin"><meta name=apple-mobile-web-app-title content="VitahLin"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://www.vitahlin.com/mysql-design-guideline/><link rel=prev href=http://www.vitahlin.com/use-clion-and-cmake-build-redis3/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Mysql数据库设计规范","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/www.vitahlin.com\/mysql-design-guideline\/"},"image":["http:\/\/www.vitahlin.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"mysql","wordcount":2178,"url":"http:\/\/www.vitahlin.com\/mysql-design-guideline\/","datePublished":"2022-03-15T12:00:00+08:00","dateModified":"2022-03-15T12:05:18+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"http:\/\/www.vitahlin.com\/images\/avatar.png"},"author":{"@type":"Person","name":"vitahlin"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=VitahLin>vitahlin</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=https://github.com/vitahlin title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=VitahLin>vitahlin</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title>关于</a><a class=menu-item href=https://github.com/vitahlin title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Mysql数据库设计规范</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://www.vitahlin.com title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>vitahlin</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/mysql/><i class="far fa-folder fa-fw"></i>mysql</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-03-15>2022-03-15</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2178 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 5 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#表结构设计>表结构设计</a></li><li><a href=#字段设计>字段设计</a></li><li><a href=#索引规范>索引规范</a></li><li><a href=#sql规范>SQL规范</a></li><li><a href=#通用约定>通用约定</a></li></ul></nav></div></div><div class=content id=content><h2 id=表结构设计>表结构设计</h2><ul><li>不在数据库做运算，同时运算的字段也无法使用索引</li><li>控制单表数量，纯 <code>INT</code> 不超过1000W行，含 <code>CHAR</code> 不超过500W</li><li>合理分表，比如按用户 UserId ，日期，地区等</li><li>单库不超过300-400个表</li><li>单表分表个数必须控制在1024个以内</li><li>表字段少而精，有利于IO高效、全表遍历、表修复快、提高并发、alter table快</li><li>单表字段上线控制在20-50个</li><li>单表不超过50个纯 <code>INT</code> 字段，不超过20个 <code>CHAR(10)</code> 字段</li><li>单表不超过<code>200Byte</code></li><li>适当牺牲范式、加入适当冗余</li></ul><h2 id=字段设计>字段设计</h2><ul><li>选用合适的数值字段类型，根据业务区分使用 <code>tinyint/int/bigint</code>，分别会占用1/4/8字节</li><li>表示是否概念的字段，使用<code>is_xxx</code>命名，数据类型为<code>UNSIGNED TINYINT</code>（1表示是，0表示否）</li><li>小数类型为<code>DECIMAL</code>，禁止使用<code>float、double</code>，存在精度缺损</li><li>时间类型为<code>BIGINT</code>，统一存储时间戳</li><li>字段长度固定或者长度近似的业务场景，适合使用<code>char</code>，能减少碎片，查询性能高</li><li>字段长度相差较大，或者更新较少的业务场景适合使用<code>VARCHAR</code>，能够减少空间</li><li>将字符串转换为数字，因为数字类型比字符串类型索引更高效、查询更快、占用空间更小</li><li>避免使用<code>ENUM</code>，因为增加新类型需要修改表结构</li><li>避免使用<code>NULL</code>字段，因为很难进行查询优化，含<code>NULL</code>复合索引无效，<code>NULL</code>列加索引需要额外空间，<code>NULL</code>只能采用 <code>IS NULL</code>或者<code>IS NOT NULL</code>，而在<code>=、!=、in、not in</code>时有大坑</li><li>少用并拆分<code>TEXT/BLOB</code>，处理性能远低于<code>VARCHAR</code>，若必须使用则拆分单独的表（建议将大字段，访问频度低的字段拆分到单独的表中存储，分离冷热数据）</li><li>不在数据库中存图片，仅保存图片存储地址（文件类同）</li><li>使用<code>INT UNSIGNED</code>存储IPv4，不要使用<code>CHAR(15)</code></li><li>使用<code>VARCHAR(20)</code>存储手机号，不要使用整数（涉及到国家代号，可能出现<code>+、-、()</code>等字符，<code>VARCHAR</code>也可以模糊查询，例如：<code>like ‘138%’</code>）</li></ul><h2 id=索引规范>索引规范</h2><ul><li>自增列或全局ID做InnoDB主键，推荐用于独立业务的<code>AUTO_INCREMENT</code>列或者全局ID生成器做代理主键</li><li>非唯一索引命名<code>idx_字段名</code></li><li>唯一索引命名<code>uk_字段名</code></li><li>主键索引命名<code>pk_xxx</code></li><li>单表索引数量控制在5个以内</li><li>合理添加所以可以改善查询，但会减慢更小，并不是索引越多越好，索引字段最好不超过表字段的20%</li><li>字符字段必须建前缀索引，<code>like '%name%'</code>不会使用索引</li><li>不在索引列做运算，否则无法使用索引，导致全表扫描</li><li>尽量不用外键，高并发时容易死锁（外键使得表之间相互耦合，影响update/delete等SQL性能，有可能造成死锁，高并发情况下容易成为数据库瓶颈）</li><li>非必要不要进行<code>JOIN</code>查询，如果要进行<code>JOIN</code>查询，被<code>JOIN</code>的字段必须类型相同，并建立索引</li><li>理解组合索引最左前缀原则，避免重复建设索引，如果建立了<code>(a,b,c)</code>相当于建立了<code>(a)、(a,b)、(a,b,c)</code></li><li>防止因字段类型不同造成的隐式转换，导致索引失效</li></ul><h2 id=sql规范>SQL规范</h2><ul><li>SQL语句尽可能简单，一条SQL语句只能在一个CPU进行运算，5000+QPS的高并发中，可能一条大SQL就把整个数据库堵死</li><li>拆解成多条简单SQL，缓存命中率更高，用上更多的CPU；减少锁表时间，特别是MyISAM</li><li>事务/连接使用原则：即开即用，用完即关</li><li>与事务无关操作放到事务外面，减少资源的占用</li><li>不破坏一致性前提下，使用多个短事务代替长事务</li><li>尽可能避免使用存储过程、触发器、Event（调试、排错、迁移都比较困难，扩展性较差），减少使用Mysql函数对结果进行处理，由程序端负责</li><li>尽量不用<code>select *</code>，只取需要的数据列，不会占用更多的CPU、内存、IO、网络带宽资源</li><li>同一个字段，将<code>OR</code>改写为<code>IN</code>，注意<code>IN</code>的个数，建议少于200</li><li>不同字段，将<code>OR</code>改成<code>UNION</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>phone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>’</span><span class=mi>159</span><span class=err>′</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>‘</span><span class=n>john</span><span class=err>’</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>=&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>phone</span><span class=o>=</span><span class=err>’</span><span class=mi>159</span><span class=err>′</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>union</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>name</span><span class=o>=</span><span class=err>’</span><span class=n>jonh</span><span class=err>’</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>避免负向查询和<code>%</code>前缀模糊查询，使用不了索引，导致全表扫描</li><li>尽量不用、少用<code>COUNT(*)</code></li><li><code>LIMIT</code> 高效分页，传统分布 <code>SELECT id FROM user LIMIT 10000, 10</code>，偏移量越大则越慢；推荐分页 <code>SELECT id FROM user WHERE id >= 10000 LIMIT 10</code></li><li>若无需对结果进行去重，使用 <code>UNION ALL</code> 而非 <code>UNION</code>， <code>UNION</code> 有去重开销</li><li>高并发DB禁止进行两个表以上的 <code>JOIN</code></li><li>同数据类型的列值进行比较（防止因字段类型不同造成的隐式转换，导致索引失效）</li><li>避免大SQL、大事务、大批量长时间占用系统资源而堵塞系统，一个SQL只能在一个CPU运算</li><li>尽量不用 <code>INSERT ... SELECT</code></li><li>Load data 批量导入数据，尽量避开高峰期操作</li><li>使用 <code>EXPLAIN</code> 查看执行计划</li><li>观察慢查询日志</li><li><code>show processlist</code> 查看进程状态</li><li>MySQL子查询大部分情况下优化较差，特别是 <code>WHERE</code> 中使用 <code>IN id</code> 的子查询，一般可用 <code>JOIN</code> 改写</li></ul><h2 id=通用约定>通用约定</h2><ul><li>永远不在程序端显示加锁，外部锁对数据库不可控，高并发时是灾难</li><li>表存储引擎必须使用InnoDB</li><li>统一字符集为UTF8，乱码：SET NAMES UTF8，必要时候使用<code>utf8mb4</code>（utf8mb4是utf8的超集，有存储4字节例如表情符号时，使用它）</li><li>库表等名称统一用小写，MySQL库表大小写敏感，字段名的大小写不敏感（Linux VS win）</li><li>表名不使用复数名词</li><li>必备三个字段 <code>id, create_at, update_at</code></li><li>表命名最好加上<code>“业务名称_表的作用”</code></li><li>库名与服务名最好一致</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-03-15&nbsp;<a class=git-hash href=https://github.com/vitahlin/vitahlin.github.io/commit/c5a3d776040008066ad083458ef2aa4451c9191c target=_blank title="commit by vitahlin(linw1225@gmail.com) c5a3d776040008066ad083458ef2aa4451c9191c: Feat mysql设计规范">
<i class="fas fa-hashtag fa-fw"></i>c5a3d77</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/mysql-design-guideline/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/mysql/>mysql</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/use-clion-and-cmake-build-redis3/ class=prev rel=prev title="macOS上用Clion CMake编译redis 3.0"><i class="fas fa-angle-left fa-fw"></i>macOS上用Clion CMake编译redis 3.0</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>