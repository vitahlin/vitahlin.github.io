---
title: '#ifdef用法'
tags: C++
categories: C++
comments: true
copyright: true
abbrlink: how_to_use_ifdef
date: 2016-11-29 20:01:33
updated: 2016-11-29 20:04:33
---

`#ifdef`用来进行条件编译。一般情况下，源程序中所有的行都参加编译。但是有时希望**对其中一部分内容只在满足一定条件才进行编译，也就是对一部分内容指定编译的条件，这就是“条件编译”**。有时，希望当满足某条件时对一组语句进行编译，而当条件不满足时则编译另一组语句。

<!--more-->

条件编译命令最常见的形式为：

```c
#ifdef 标识符
    程序段1
#else
    程序段2
#endif
```

它的作用是：当标识符已经被定义过(一般是用`#define`命令定义)，则对程序段1进行编译，否则编译程序段2。

其中`#else`部分也可以没有，即：
  
```c  
#ifdef
    程序段1
#endif
```

这里的“程序段”可以是语句组，也可以是命令行。这种条件编译可以提高C源程序的通用性。

例如，我们有一个数据类型，在Windows平台中，应该使用`long`类型表示，而在其他平台应该使用`float`表示，这样往往需要对源程序作必要的修改，这就降低了程序的通用性。可以用以下的条件编译： 

```c
#ifdef WINDOWS
    #define MYTYPE long
#else
    #define MYTYPE float
#endif
```

如果在Windows上编译程序，则可以在程序的开始加上

```c
#define WINDOWS
```

这样则编译下面的命令行:

```c
#define MYTYPE long
```

如果在这组条件编译命令之前曾出现以下命令行：

```c
#define WINDOWS 0
```

则预编译后程序中的`MYTYPE`都用`float`代替。这样，源程序可以不必作任何修改就可以用于不同类型的计算机系统。当然以上介绍的只是一种简单的情况，可以根据此思路设计出其它的条件编译。

例如，在调试程序时，常常希望输出一些所需的信息，而在调试完成后不再输出这些信息。可以在源程序中插入以下的条件编译段:

```c
#ifdef DEBUG
    print ("device_open(%p)\n", file);
#endif
```

如果在它的前面有以下命令行：

```c
#define DEBUG
```

则在程序运行时输出file指针的值，以便调试分析。调试完成后只需将这个`define`命令行删除即可。有人可能觉得不用条件编译也可达此目的，即在调试时加一批`printf`语句，调试后一一将`printf`语句删除去。的确，这是可以的。但是，当调试时加的`printf`语句比较多时，修改的工作量是很大的。用条件编译，则不必一一删改printf语句，只需删除前面的一条`#define DEBUG`命令即可，这时所有的用`DEBUG`作标识符的条件编译段都使其中的`printf`语句不起作用，即起统一控制的作用，如同一个“开关”一样。

有时也采用下面的形式：

```c
#ifndef 标识符 
    程序段1
#else
    程序段2
#endif
```

只是第一行与第一种形式不同：将`ifdef`改为`ifndef`。它的作用是：**若标识符未被定义则编译程序段1，否则编译程序段2**。这种形式与第一种形式的作用相反。
以上两种形式用法差不多，根据需要任选一种，视方便而定。还有一种形式，就是`#if`后面的是一个表达式，而不是一个简单的标识符：

```c
#if 表达式
    程序段1
#else
    程序段2
#endif
```

它的作用是：当指定的表达式值为真（非零）时就编译程序段1，否则编译程序段2。可以事先给定一定条件，使程序在不同的条件下执行不同的功能。   例如：

```c
#include<stdio.h> 
#define LETTER 1

void main()
{
    int i=0;
    char str[20]="C Language";
    char c;
    while((c=str[i])!='\0')
    {
        i++;
        #if LETTER
            if(c>='a'&&c<='z') c=c-32;
        #else
            if(c>='A'&&c<='Z') c=c+32;
        #endif

        printf("%c",c);
    }
}  
```

运行结果为：

```c
C LANGUAGE
```

现在先定义`LETTER`为1，这样在预处理条件编译命令时，由于`LETTER`为真（非零），则对第一个if语句进行编译，运行时使小写字母变大写。如果将程序第一行改为：

```c
#define LETTER 0
```

则在预处理时，对第二个if语句进行编译处理，使大写字母变成小写字母（大写字母与相应的小写字母的ASCII代码差32）。此时运行情况为：

```c
c language
```