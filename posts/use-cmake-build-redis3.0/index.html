<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=color-scheme content="light dark"><meta name=author content="Vitah Lin"><meta name=description content="版本说明     macOS：11.2.3 CMake：3.19.6 Clion：2020.3.2  克隆redis3.0源代码    去Github上面下载3.0版本的代码：https://codeload.github.com/redis/redis/zip/3.0 解压后将目录redis-3.0重新命名为redis 。
创建对应的CMakeLists.txt    使用cmake 编译redis 源码的话需要创建对应的CMakeLists.txt 文件，创建完成后，直接在redis 目录执行命令cmake . 即可。
redis/deps/hiredis/CMakeLists.txt    add_library(hiredis STATIC hiredis.c net.c dict.c net.c sds.c async.c ) redis/deps/linenoise/CMakeLists.txt    add_library(linenoise linenoise.c) redis/deps/lua/CMakeLists.txt    set(LUA_SRC src/lapi.c src/lcode.c src/ldebug.c src/ldo.c src/ldump.c src/lfunc.c src/lgc.c src/llex.c src/lmem.c src/lobject.c src/lopcodes.c src/lparser.c src/lstate.c src/lstring.c src/ltable.c src/ltm.c src/lundump.c src/lvm.c src/lzio.c src/strbuf."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="macOS采用CMake编译redis30源代码"><meta name=twitter:description content="版本说明     macOS：11.2.3 CMake：3.19.6 Clion：2020.3.2  克隆redis3.0源代码    去Github上面下载3.0版本的代码：https://codeload.github.com/redis/redis/zip/3.0 解压后将目录redis-3.0重新命名为redis 。
创建对应的CMakeLists.txt    使用cmake 编译redis 源码的话需要创建对应的CMakeLists.txt 文件，创建完成后，直接在redis 目录执行命令cmake . 即可。
redis/deps/hiredis/CMakeLists.txt    add_library(hiredis STATIC hiredis.c net.c dict.c net.c sds.c async.c ) redis/deps/linenoise/CMakeLists.txt    add_library(linenoise linenoise.c) redis/deps/lua/CMakeLists.txt    set(LUA_SRC src/lapi.c src/lcode.c src/ldebug.c src/ldo.c src/ldump.c src/lfunc.c src/lgc.c src/llex.c src/lmem.c src/lobject.c src/lopcodes.c src/lparser.c src/lstate.c src/lstring.c src/ltable.c src/ltm.c src/lundump.c src/lvm.c src/lzio.c src/strbuf."><meta property="og:title" content="macOS采用CMake编译redis30源代码"><meta property="og:description" content="版本说明     macOS：11.2.3 CMake：3.19.6 Clion：2020.3.2  克隆redis3.0源代码    去Github上面下载3.0版本的代码：https://codeload.github.com/redis/redis/zip/3.0 解压后将目录redis-3.0重新命名为redis 。
创建对应的CMakeLists.txt    使用cmake 编译redis 源码的话需要创建对应的CMakeLists.txt 文件，创建完成后，直接在redis 目录执行命令cmake . 即可。
redis/deps/hiredis/CMakeLists.txt    add_library(hiredis STATIC hiredis.c net.c dict.c net.c sds.c async.c ) redis/deps/linenoise/CMakeLists.txt    add_library(linenoise linenoise.c) redis/deps/lua/CMakeLists.txt    set(LUA_SRC src/lapi.c src/lcode.c src/ldebug.c src/ldo.c src/ldump.c src/lfunc.c src/lgc.c src/llex.c src/lmem.c src/lobject.c src/lopcodes.c src/lparser.c src/lstate.c src/lstring.c src/ltable.c src/ltm.c src/lundump.c src/lvm.c src/lzio.c src/strbuf."><meta property="og:type" content="article"><meta property="og:url" content="https://vitahlin.github.io/posts/use-cmake-build-redis3.0/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-17T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-17T00:00:00+00:00"><title>macOS采用CMake编译redis30源代码 · Vitah Lin</title><link rel=canonical href=https://vitahlin.github.io/posts/use-cmake-build-redis3.0/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 integrity="sha256-hEIt6X6xzye8ubyk8/uxjz68cRZHsJxoKS9fQ8idUGQ=" crossorigin><link rel=stylesheet href=/css/coder.min.abe8b6775d85a01169c10329309df501aa8a008ab354002f7858f077cae76020.css integrity="sha256-q+i2d12FoBFpwQMpMJ31AaqKAIqzVAAveFjwd8rnYCA=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.89c82b6022b96f77aeb521b240daec4f87ea029d84d1c78b8acd0735b91b3c92.css integrity="sha256-icgrYCK5b3eutSGyQNrsT4fqAp2E0ceLis0HNbkbPJI=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><script defer src=https://twemoji.maxcdn.com/v/13.0.1/twemoji.min.js integrity=sha384-5f4X0lBluNY/Ib4VhGx0Pf6iDCF99VGXJIyYy7dDLY5QlEd7Ap0hICSSZA1XYbc4 crossorigin=anonymous></script><meta name=generator content="Hugo 0.81.0"></head><body class=colorscheme-auto onload=twemoji.parse(document.body)><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Vitah Lin</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://vitahlin.github.io/posts/use-cmake-build-redis3.0/>macOS采用CMake编译redis30源代码</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2021-03-17T00:00:00Z>March 17, 2021</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>2-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i><a href=/categories/redis/>Redis</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i><a href=/tags/redis/>Redis</a>
<span class=separator>•</span>
<a href=/tags/cmake/>CMake</a></div></div></header><div><h1 id=版本说明>版本说明
<a class=heading-link href=#%e7%89%88%e6%9c%ac%e8%af%b4%e6%98%8e><i class="fa fa-link" aria-hidden=true></i></a></h1><ul><li><strong>macOS：11.2.3</strong></li><li><strong>CMake：3.19.6</strong></li><li><strong>Clion：2020.3.2</strong></li></ul><h1 id=克隆redis30源代码>克隆redis3.0源代码
<a class=heading-link href=#%e5%85%8b%e9%9a%86redis30%e6%ba%90%e4%bb%a3%e7%a0%81><i class="fa fa-link" aria-hidden=true></i></a></h1><p>去Github上面下载3.0版本的代码：<a href=https://codeload.github.com/redis/redis/zip/3.0>https://codeload.github.com/redis/redis/zip/3.0</a>
解压后将目录<code>redis-3.0</code>重新命名为<code>redis</code> 。</p><h1 id=创建对应的cmakeliststxt>创建对应的CMakeLists.txt
<a class=heading-link href=#%e5%88%9b%e5%bb%ba%e5%af%b9%e5%ba%94%e7%9a%84cmakeliststxt><i class="fa fa-link" aria-hidden=true></i></a></h1><p>使用<code>cmake</code> 编译<code>redis</code> 源码的话需要创建对应的<code>CMakeLists.txt</code> 文件，创建完成后，直接在<code>redis</code> 目录执行命令<code>cmake .</code> 即可。</p><h2 id=redisdepshirediscmakeliststxt>redis/deps/hiredis/CMakeLists.txt
<a class=heading-link href=#redisdepshirediscmakeliststxt><i class="fa fa-link" aria-hidden=true></i></a></h2><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>add_library(hiredis STATIC
        hiredis.c net.c dict.c net.c sds.c async.c
        )
</code></pre></div><h2 id=redisdepslinenoisecmakeliststxt>redis/deps/linenoise/CMakeLists.txt
<a class=heading-link href=#redisdepslinenoisecmakeliststxt><i class="fa fa-link" aria-hidden=true></i></a></h2><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>add_library(linenoise linenoise.c)
</code></pre></div><h2 id=redisdepsluacmakeliststxt>redis/deps/lua/CMakeLists.txt
<a class=heading-link href=#redisdepsluacmakeliststxt><i class="fa fa-link" aria-hidden=true></i></a></h2><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>set(LUA_SRC
        src/lapi.c src/lcode.c src/ldebug.c src/ldo.c src/ldump.c src/lfunc.c
        src/lgc.c src/llex.c src/lmem.c src/lobject.c src/lopcodes.c src/lparser.c
        src/lstate.c src/lstring.c src/ltable.c src/ltm.c src/lundump.c src/lvm.c
        src/lzio.c src/strbuf.c src/fpconv.c src/lauxlib.c src/lbaselib.c src/ldblib.c
        src/liolib.c src/lmathlib.c src/loslib.c src/ltablib.c src/lstrlib.c src/loadlib.c
        src/linit.c src/lua_cjson.c src/lua_struct.c src/lua_cmsgpack.c src/lua_bit.c
        )
add_library(lua STATIC <span>$</span>{LUA_SRC})
</code></pre></div><h2 id=redisdepscmakeliststxt>redis/deps/CMakeLists.txt
<a class=heading-link href=#redisdepscmakeliststxt><i class="fa fa-link" aria-hidden=true></i></a></h2><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>add_subdirectory(hiredis)
add_subdirectory(linenoise)
add_subdirectory(lua)
</code></pre></div><h2 id=rediscmakeliststxt>redis/CMakeLists.txt
<a class=heading-link href=#rediscmakeliststxt><i class="fa fa-link" aria-hidden=true></i></a></h2><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>cmake_minimum_required(VERSION 3.0 FATAL_ERROR)

project(redis3.0 VERSION 3.0)

set(CMAKE_BUILD_TYPE <span style=font-style:italic>&#34;Debug&#34;</span>)

get_filename_component(REDIS_ROOT <span style=font-style:italic>&#34;${CMAKE_CURRENT_SOURCE_DIR}&#34;</span> ABSOLUTE)

add_subdirectory(deps)

set(SRC_SERVER src/redis.c
        <span># 解决mac下编译报错问题
</span><span></span>        <span># src/ae_epoll.c src/ae_evport.c src/ae_select.c src/ae_kqueue.c
</span><span></span>        src/adlist.c src/ae.c src/anet.c src/aof.c src/asciilogo.h src/bio.c src/bitops.c src/blocked.c
        src/cluster.c src/config.c src/crc64.c src/crc16.c src/db.c src/debug.c src/dict.c src/endianconv.c
        src/hyperloglog.c src/intset.c src/latency.c src/lzf_c.c src/lzf_d.c src/memtest.c src/multi.c
        src/networking.c src/notify.c src/object.c src/pqsort.c src/pubsub.c src/rand.c src/rdb.c src/release.c
        src/replication.c src/rio.c src/scripting.c src/sds.c src/sentinel.c src/setproctitle.c src/sha1.c
        src/slowlog.c src/sort.c src/sparkline.c src/syncio.c src/t_hash.c src/t_list.c src/t_set.c src/t_string.c
        src/t_zset.c src/util.c src/ziplist.c src/zipmap.c src/zmalloc.c
        )

set(EXECUTABLE_OUTPUT_PATH src)
link_directories(deps/linenoise deps/lua/src deps/hiredis)
add_executable(redis-server <span>$</span>{SRC_SERVER})

target_include_directories(redis-server
        PRIVATE <span>$</span>{REDIS_ROOT}/deps/linenoise
        PRIVATE <span>$</span>{REDIS_ROOT}/deps/hiredis
        PRIVATE <span>$</span>{REDIS_ROOT}/deps/lua/src
        )
target_link_libraries(redis-server
        PRIVATE pthread
        PRIVATE dl
        PRIVATE m
        PRIVATE lua
        PRIVATE linenoise
        PRIVATE hiredis
        )

set(CLIENT_SRC src/redis-cli.c
        src/anet.c src/sds.c src/adlist.c src/zmalloc.c
        src/release.c src/anet.c src/ae.c src/crc64.c
        )
add_executable(redis-cli <span>$</span>{CLIENT_SRC})

target_include_directories(redis-cli
        PRIVATE <span>$</span>{REDIS_ROOT}/deps/linenoise
        PRIVATE <span>$</span>{REDIS_ROOT}/deps/hiredis
        PRIVATE <span>$</span>{REDIS_ROOT}/deps/lua/src
        )
target_link_libraries(redis-cli
        PRIVATE pthread
        PRIVATE m
        PRIVATE linenoise
        PRIVATE hiredis
        )
</code></pre></div><h1 id=错误处理>错误处理
<a class=heading-link href=#%e9%94%99%e8%af%af%e5%a4%84%e7%90%86><i class="fa fa-link" aria-hidden=true></i></a></h1><h2 id=fatal-error-sysepollh-file-not-found>fatal error: &lsquo;sys/epoll.h&rsquo; file not found
<a class=heading-link href=#fatal-error-sysepollh-file-not-found><i class="fa fa-link" aria-hidden=true></i></a></h2><p>在macOS下编译会出现这个错误，是因为epoll是linux独有的，macOS上并没有<code>sys/epoll.h</code>头文件，因此编译出错。但macOS上使用<code>kqueue</code>代替了<code>epoll</code>，这里可以直接注释相关代码。</p><p>redis/CMakeLists.txt中注释下列文件：</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=font-style:italic>#        src/ae_epoll.c</span>
<span style=font-style:italic>#        src/ae_evport.c</span>
<span style=font-style:italic>#        src/ae_select.c</span>
<span style=font-style:italic>#        src/ae_kqueue.c</span>
</code></pre></div><h2 id=fatal-error-releaseh-file-not-found>fatal error: &lsquo;release.h&rsquo; file not found
<a class=heading-link href=#fatal-error-releaseh-file-not-found><i class="fa fa-link" aria-hidden=true></i></a></h2><p>在redis目录下执行脚本即可，用于生成缺失的 <code>release.h</code> 文件。</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ cd src/
$ sh mkreleasehdr.sh
</code></pre></div><h1 id=clion导入项目>Clion导入项目
<a class=heading-link href=#clion%e5%af%bc%e5%85%a5%e9%a1%b9%e7%9b%ae><i class="fa fa-link" aria-hidden=true></i></a></h1><p>直接打开项目，选择 <strong>Open as：CMake project</strong>：
<img src="https://cdn.nlark.com/yuque/0/2021/png/1176204/1615984488542-0c3be33e-6733-4858-b83c-fb66f24cbd57.png#align=left&display=inline&height=194&margin=%5Bobject%20Object%5D&name=image.png&originHeight=388&originWidth=772&size=34113&status=done&style=none&width=386" alt=image.png>
打开后就可以直接运行了， <code>redis-serve</code> 即redis服务端， <code>redis-cli</code> 即客户端。</p></div><footer><script src=https://utteranc.es/client.js repo=vitahlin/hugo-blog-utterances issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2021
Vitah Lin
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/dark-mode.min.aee9c8a464eb7b3534c7110f7c5e169e7039e2fd92710e0626d451d6725af137.js integrity="sha256-runIpGTrezU0xxEPfF4WnnA54v2ScQ4GJtRR1nJa8Tc="></script></body></html>